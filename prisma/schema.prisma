// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Project {
  id                   String   @id @default(cuid())
  url                  String
  email                String
  region               String?
  industry             Industry @default(RESIDENTIAL_REAL_ESTATE)
  humanBrandStatement  String?  @db.Text
  createdBy            String?
  status               ProjectStatus @default(PENDING)
  progressMessage      String?  @default("Initializing...")
  progressPercent      Int?     @default(0)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relations
  sources     Source[]
  llmRuns     LlmRun[]
  findings    Finding[]
  competitors Competitor[]
  reports     Report[]

  @@index([status])
  @@index([createdAt])
  @@index([email])
  @@index([industry])

}

model Source {
  id           String   @id @default(cuid())
  projectId    String
  type         SourceType
  url          String
  contentHash  String?
  textExcerpt  String?  @db.Text
  fullContent  String?  @db.Text
  metadata     Json?
  createdAt    DateTime @default(now())

  project      Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([type])
}

model LlmRun {
  id          String   @id @default(cuid())
  projectId   String
  provider    LlmProvider
  model       String
  temperature Float?
  maxTokens   Int?
  settings    Json?
  rawResponse Json
  tokensUsed  Int?
  cost        Float?
  status      RunStatus @default(PENDING)
  error       String?
  createdAt   DateTime @default(now())

  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  findings    Finding[]

  @@index([projectId])
  @@index([provider])
  @@index([status])
}

model Finding {
  id           String      @id @default(cuid())
  projectId    String
  llmRunId     String?
  provider     LlmProvider?
  kind         FindingKind
  value        Json
  evidenceRef  String?     @db.Text
  confidence   Float?
  createdAt    DateTime    @default(now())

  project      Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  llmRun       LlmRun?     @relation(fields: [llmRunId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([llmRunId])
  @@index([provider])
  @@index([kind])
  @@index([projectId, provider, kind])
}

model Competitor {
  id        String   @id @default(cuid())
  projectId String
  name      String
  url       String
  axisX     Float?
  axisY     Float?
  notes     String?  @db.Text
  metadata  Json?
  createdAt DateTime @default(now())

  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model Report {
  id         String   @id @default(cuid())
  projectId  String
  urlToken   String   @unique
  isPublic   Boolean  @default(false)
  version    Int      @default(1)
  data       Json
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  expiresAt  DateTime?

  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([urlToken])
}

// New models for training data and benchmarking

model IndustryBenchmark {
  id                      String   @id @default(cuid())
  industry                Industry
  metric                  String   // e.g., "clarity_score", "trust_score", "overall_strength"

  // Statistical data
  average                 Float
  median                  Float
  percentile25            Float
  percentile75            Float
  percentile90            Float
  standardDeviation       Float?

  // Sample data
  sampleSize              Int
  minValue                Float
  maxValue                Float

  // Metadata
  calculatedAt            DateTime @default(now())
  dataSourcePeriodStart   DateTime?
  dataSourcePeriodEnd     DateTime?
  notes                   String?  @db.Text

  @@unique([industry, metric, calculatedAt])
  @@index([industry])
  @@index([metric])
}

model BrandComparison {
  id                String   @id @default(cuid())

  // Primary brand
  primaryProjectId  String
  primaryUrl        String
  primaryIndustry   Industry

  // Comparison brand (if any)
  compareProjectId  String?
  compareUrl        String?

  // Comparison metrics (JSON for flexibility)
  comparisonData    Json     // Stores scores, deltas, insights

  // Categorization
  comparisonType    ComparisonType @default(SIMILAR_INDUSTRY)
  tags              String[] // e.g., ["luxury", "coastal", "active-adult"]

  // Metadata
  createdAt         DateTime @default(now())
  notes             String?  @db.Text

  @@index([primaryProjectId])
  @@index([compareProjectId])
  @@index([primaryIndustry])
  @@index([comparisonType])
}

model TrainingDataset {
  id                String   @id @default(cuid())
  projectId         String   @unique

  // Classification
  industry          Industry
  qualityRating     Int?     // 1-5 rating for data quality
  isReferenceExample Boolean @default(false) // Mark as exemplary
  isBenchmark       Boolean  @default(false) // Use for industry benchmarks

  // Tags for categorization
  brandTags         String[] // e.g., ["luxury", "budget", "urban", "suburban"]
  characteristics   String[] // e.g., ["high-clarity", "strong-differentiation"]

  // Metadata
  addedAt           DateTime @default(now())
  reviewedAt        DateTime?
  reviewedBy        String?
  notes             String?  @db.Text

  @@index([industry])
  @@index([isReferenceExample])
  @@index([isBenchmark])
  @@index([qualityRating])
}

model BrandInsight {
  id                String   @id @default(cuid())

  // Source
  projectId         String
  industry          Industry

  // Insight data
  insightType       InsightType
  title             String
  description       String   @db.Text
  data              Json     // Flexible storage for insight-specific data

  // Context
  confidence        Float?   // 0-1 confidence score
  basedOnSample     Int?     // Number of projects this insight is based on

  // Metadata
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([projectId])
  @@index([industry])
  @@index([insightType])
}

enum ProjectStatus {
  PENDING
  SCRAPING
  ANALYZING
  COMPLETED
  FAILED
}

enum SourceType {
  MAIN_PAGE
  ABOUT
  HOMES
  AMENITIES
  LOCATION
  CONTACT
  PRESS
  OTHER
}

enum LlmProvider {
  OPENAI
  ANTHROPIC
  GOOGLE
}

enum RunStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

enum FindingKind {
  BRAND_SYNOPSIS
  POSITIONING_PILLAR
  TONE_OF_VOICE
  BUYER_SEGMENT
  AMENITY_CLAIM
  TRUST_SIGNAL
  RECOMMENDATION
  CLARITY_SCORE
  SPECIFICITY_SCORE
  DIFFERENTIATION_SCORE
  TRUST_SCORE
  // Real Estate Specific
  PRODUCT_MIX
  PRICE_POSITIONING
  COMPLIANCE_RISK
  LOCATION_DRIVER
  BUILDER_CREDIBILITY
}

enum Industry {
  RESIDENTIAL_REAL_ESTATE    // Active for production
  COMMERCIAL_REAL_ESTATE
  HOSPITALITY
  HEALTHCARE
  FINANCIAL_SERVICES
  TECHNOLOGY                 // Legacy - kept for backward compatibility
  TECHNOLOGY_SAAS
  PROFESSIONAL_SERVICES
  RETAIL
  EDUCATION
  MANUFACTURING
  SENIOR_LIVING
  MULTIFAMILY
  OTHER                      // Legacy - kept for backward compatibility
}

enum ComparisonType {
  SIMILAR_INDUSTRY    // Same industry comparison
  CROSS_INDUSTRY      // Different industry comparison
  HISTORICAL          // Same brand over time
  COMPETITIVE         // Direct competitors
  ASPIRATIONAL        // Benchmark against top performers
}

enum InsightType {
  INDUSTRY_TREND      // Patterns across industry
  IMPROVEMENT_OPPORTUNITY // Specific improvement identified
  COMPETITIVE_ADVANTAGE   // Strength vs competitors
  BEST_PRACTICE      // Exemplary approach
  COMMON_MISTAKE     // Frequently seen issue
  EMERGING_PATTERN   // New trend detected
}
